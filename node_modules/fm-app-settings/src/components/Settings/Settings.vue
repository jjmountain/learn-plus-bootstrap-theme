<script>
import { Session } from '~/utils/settings'
import Collapse from '~/components/Settings/Collapse'
import FormImageGroup from '~/components/FormImageGroup'

export default {
  components: {
    Collapse,
    FormImageGroup
  },
  data() {
    return {
      session: null,
      settings: {},
    }
  },
  props: {
    namespace: {
      type: String,
      default: null
    },
    options: {
      type: Array,
      required: true
    },
    debug: {
      type: Boolean,
      default: false
    }
  },
  watch: {
    settings: {
      deep: true,
      handler(value) {
        this.setSettings()
      }
    }
  },
  created() {
    this.session = new Session(this.namespace)
    this.initSettings()
  },
  methods: {
    initSettings() {
      let memory = this.session.memory('settings')

      this.options.forEach(option => {
        option.children.forEach(group => {
          if (this.settings[`${option.id}.${group.id}`] === undefined) {
            let value

            if (group.cookies === undefined || group.cookies !== false) {
              try {
                value = memory[`${option.id}.${group.id}`]
              } catch(e) {}
            }
            
            const def = group.options.find(o => o.selected === true)
            if (!value && def !== undefined) {
              value = def.value
            }
            if (!value && value !== false) {
              value = group.options[0].value
            }

            this.$set(this.settings, `${option.id}.${group.id}`, value)
          }
        })
      })
    },
    setSettings(reload) {
      this.session.save('settings', this.settings)

      this.$root.$emit('fm:settings:state', this.settings)

      if (reload) {
        location.reload()
      }
    }
  }
}
</script>
