<template>
  <div class="form-inline">
    <!-- iPhone 6s Plus (414 x 736) -->
    <label class="custom-control custom-radio custom-radio-icon m-0">
      <input v-model="screen" type="radio" class="custom-control-input" value="phone">
      <span class="custom-control-indicator material-icons">smartphone</span>
    </label>
    <!-- iPad mini 4 (1024 x 768) -->
    <label class="custom-control custom-radio custom-radio-icon m-0">
      <input v-model="screen" type="radio" class="custom-control-input" value="tablet">
      <span class="custom-control-indicator material-icons">tablet_mac</span>
    </label>
    <!-- Desktop (100%) -->
    <label class="custom-control custom-radio custom-radio-icon m-0">
      <input v-model="screen" type="radio" class="custom-control-input" value="desktop">
      <span class="custom-control-indicator material-icons">desktop_mac</span>
    </label>
  </div>
</template>

<script>
  export default {
    data() {
      return {
        screen: 'desktop',
        screenConfig: {
          phone: {
            width: '414px',
            height: '736px'
          },
          tablet: {
            width: '1024px',
            height: '768px'
          }
        },
      }
    },
    mounted() {
      if (!window.frameElement && window.updateScreen === undefined) {
        window.updateScreen = this.updateScreen.bind(this)
      }
      
      let screen = Cookies.get('app_settings_screen')
      if (screen) {
        this.screen = screen
      }
    },
    watch: {
      screen(value) {
        Cookies.set('app_settings_screen', value)
        this.setScreen(value)
      },
    },
    methods: {
      exitScreenListener(e) {
        e.preventDefault()
        e.stopPropagation()
        this.screen = 'desktop'
      },
      updateScreen(screen) {
        this.screen = screen
      },
      setScreen(screen) {
        if (window.frameElement) {
          return window.parent.updateScreen(screen)
        }

        var iframeId = 'app-settings-screen-preview'
        var iframe  = document.getElementById(iframeId)
        var body = document.querySelector('body')

        if (iframe && screen === 'desktop') {
          body.classList.remove('has-app-screen')
          body.removeEventListener('click', this.exitScreenListener)
          body.removeChild(iframe)
          return
        }

        if (this.screenConfig[screen] === undefined) {
          return
        }

        if (!iframe) {
          iframe = document.createElement('iframe')
          body.appendChild(iframe)
          iframe.addEventListener('load', () => body.addEventListener('click', this.exitScreenListener))
        }

        body.classList.add('has-app-screen')

        var config = this.screenConfig[screen]
        var height = Math.min(parseInt(config.height, 10), document.documentElement.clientHeight - 100)

        iframe.id               = iframeId
        iframe.src              = window.location.href
        iframe.style.marginLeft = (parseInt(config.width, 10) / 2) * -1 + 'px'
        iframe.style.marginTop  = (parseInt(height, 10) / 2) * -1 + 'px'
        iframe.style.width      = config.width
        iframe.style.height     = height + 'px'
      },
    }
  }
</script>