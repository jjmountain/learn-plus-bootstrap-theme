<template>
  <div class="app-settings app-fab--absolute dropup" data-dropdown-dismissable>
    <button class="mdc-fab material-icons dropdown-toggle" data-caret="false" aria-label="Settings" data-toggle="dropdown">
      <span class="mdc-fab__icon">
        settings
      </span>
    </button>
    <div class="dropdown-menu dropdown-menu-right">
      <button role="button" class="close" data-dismiss="dropdown" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>

      <template v-if="groups.length > 0" v-for="item, index in groups">
        <template v-if="groupEnabled(index)">
          <div class="dropdown-header">{{ item.label || item.id }}</div>
          <div class="dropdown-item">
            <div class="custom-control custom-radio custom-control-inline" v-for="control in item.themes">
              <input v-model="group[item.id]" type="radio" :id="'theme_' + control.id" class="custom-control-input" :value="control.id">
              <label class="custom-control-label" :for="'theme_' + control.id">{{ control.label || control.id }}</label>
            </div>
          </div>
          <div class="dropdown-divider"></div>
        </template>
      </template>

      <template v-if="themes.length > 0">
        <div class="dropdown-header">Theme</div>
        <div class="dropdown-item">
          <div class="custom-control custom-radio custom-control-inline" v-for="themeControl in themes" :class="'custom-theme-color--' + themeControl.id">
            <input v-model="theme" type="radio" :id="'theme_' + themeControl.id" class="custom-control-input" :value="themeControl.id">
            <label class="custom-control-label" :for="'theme_' + themeControl.id">{{ themeControl.id }}</label>
          </div>
        </div>
        <div class="dropdown-divider"></div>
      </template>

      <template v-if="groupEnabled('sidebar')">
        <div class="dropdown-header">Drawer position</div>
        <div class="dropdown-item">
          <div class="custom-control custom-radio custom-control-inline">
            <input v-model="drawerPosition" type="radio" id="drawerPositionStart" class="custom-control-input" value="start">
            <label class="custom-control-label" for="drawerPositionStart">Start</label>
          </div>
          <div class="custom-control custom-radio custom-control-inline">
            <input v-model="drawerPosition" type="radio" id="drawerPositionEnd" class="custom-control-input" value="end">
            <label class="custom-control-label" for="drawerPositionEnd">End</label>
          </div>
        </div>
        <div class="dropdown-divider"></div>
      </template>

      <div class="dropdown-header">Text Direction</div>
      <div class="dropdown-item">
        <div class="custom-control custom-checkbox-toggle custom-control-inline mr-1">
          <input v-model="rtl" type="checkbox" id="app_settings_rtl" class="custom-control-input">
          <label class="custom-control-label" for="app_settings_rtl">RTL</label>
        </div>
        <label for="app_settings_rtl" class="mb-0">RTL</label>
      </div>
    </div>
  </div>
</template>

<script>
  import queryString from 'query-string'
  import { Settings } from '~/utils/settings'

  const settings = new Settings()

  const doc = document.querySelector('html')

  const themableStylesheets = document.querySelectorAll('link[data-fm-app-settings-themable]')

  export default {
    props: {
      namespace: {
        type: String,
        default() => settings.namespace
      },
      themes: {
        type: Array,
        default() {
          return []
        },
      },
      groups: {
        type: Array,
        default() {
          return []
        }
      },
      themeConfig: {
        type: Object,
        default() {
          return {}
        }
      }
    },
    data() {
      return {
        theme: 'default',
        rtl: false,
        drawerPosition: 'start',
        loadedStylesheets: 0,
        loadedStylesheetsDone: null,
        group: {}
      }
    },
    mounted() {
      settings.namespace = this.namespace
      window.addEventListener('hashchange', () => this.onHashChange())

      $(this.$el).dropdownDismissable()
      
      $(this.$el)
        .on('shown.bs.dropdown', () => settings.forget('closed'))
        .on('hidden.bs.dropdown', () => settings.save('closed', true))

      // OPEN
      if (!settings.memory('closed')) {
        $(this.$el.querySelector('[data-toggle="dropdown"]')).dropdown('toggle')
      }

      if (this.drawerLayoutNode) {
        this.drawerLayoutNode.addEventListener('domfactory-component-upgraded', () => this.init())
      }
      else {
        this.init()
      }
    },
    beforeDestroy() {
      window.removeEventListener('hashchange', () => this.onHashChange())
    },
    watch: {
      rtl(value) {
        settings.save('rtl', value)
        this.setTextDirection(value)
      },
      drawerPosition(value) {
        settings.save('drawerPosition', value)
        this.setDrawerPosition(value)
      },
      theme(value) {
        settings.save('theme', value)
        this.setTheme(value)
        this.setThemeElements(value)
      },
      group: {
        deep: true,
        handler(value) {
          Object.keys(value).forEach(g => this.setThemeElements(value[g]))
          settings.save('group', value)
        }
      }
    },
    computed: {
      drawerNode() {
        return document.querySelector('.mdk-drawer')
      },
      drawerLayoutNode() {
        return document.querySelector('.mdk-drawer-layout')
      },
      groupsEnabled() {
        return this.groups.filter((g, index) => this.groupEnabled(index))
      }
    },
    methods: {
      init () {
        // THEME
        let theme = settings.memory('theme')
        if (theme) {
          this.theme = theme
        }

        // RTL
        if (settings.memory('rtl')) {
          this.rtl = true
        }

        // DRAWER POSITION
        let drawerPosition = settings.memory('drawerPosition')
        if (drawerPosition) {
          this.drawerPosition = drawerPosition
        }

        let group = settings.memory('group')
        if (group) {
          this.group = group
        }
        this.groupsEnabled.forEach(g => {
          if (!this.group[g.id]) {
            const def = g.themes.find(t => t.default === true)
            this.$set(this.group, g.id, def ? def.id : g.themes[0].id)
          }
        })

        if (location.hash) {
          this.onHashChange()
        }
      },

      groupEnabled(index) {
        let group = this.groups[index] || this.groups.find(g => g.id === index)
        if (group !== undefined) {
          return group.themes.length > 0 && (!group.test || document.querySelector(group.test))
        }
      },

      // #fm:rtl=false&g=navbar&t=navbar-light&g=sidebar&t=sidebar-dark
      onHashChange() {
        if (location.hash.indexOf('#fm:') !== 0) {
          return
        }

        var config = queryString.parse(location.hash.replace(/^(#fm:)/, ''))
        Object.keys(config).forEach(k => {
          if (['true', 'false'].includes(config[k])) {
            config[k] = config[k] === 'true'
          }
          if (['rtl'].includes(k)) {
            this[k] = config[k]
          }
        })

        if (config.g !== undefined && config.t !== undefined) {
          if (!(config.g instanceof Array)) {
            config.g = [config.g]
          }
          
          config.g.forEach((g, index) => {
            let value = config.t instanceof Array 
              ? config.t[index] 
              : config.t

            const groupEnabled = !! this.groupEnabled(g)
            let valueExists

            try {
              valueExists = !! this.groups
                .find(tg => tg.id === g)
                .themes
                .find(t => t.id === value)
            }
            catch (e) {}

            if (groupEnabled && valueExists) {
              this.$set(this.group, g, value)
            }
          })
        }

        // location.hash = ''
      },
      setTextDirection(rtl) {
        doc.setAttribute('dir', rtl ? 'rtl' : 'ltr')
        if (this.drawerLayoutNode) {
          this.drawerLayoutNode.mdkDrawerLayout._resetLayout()
        }
        if (this.drawerNode) {
          this.drawerNode.mdkDrawer._resetPosition()
        }
        $(this.$el.querySelector('.dropdown-toggle')).dropdown('update')
      },
      setDrawerPosition(value) {
        if (this.drawerNode) {
          this.drawerNode.mdkDrawer.align = value
        }
      },
      setThemeElements(theme) {
        if (this.themeConfig[theme] === undefined && this.themeConfig['default'] === undefined) {
          return
        }
        var config = this.themeConfig[theme] === undefined ? this.themeConfig['default'] : this.themeConfig[theme]
        for (var selector in config) {
          if (config.hasOwnProperty(selector)) {
            var element = config[selector]
            var node = document.querySelector(selector)
            if (!node) {
              return
            }
            if (element.addClass) {
              element.addClass.forEach(className => {
                node.classList.add(className)
              })
            }
            if (element.removeClass) {
              element.removeClass.forEach(className => {
                node.classList.remove(className)
              })
            }
            if (element.src) {
              node.src = element.src
            }
          }
        }
      },
      idfy(value) {
        return value.replace(/\.|\//g, '-')
      },
      loadStylesheet(file) {
        var cssId = this.idfy(file.split('themes/').pop())
        if (!document.getElementById(cssId)) {
          var head  = document.getElementsByTagName('head')[0]
          var link  = document.createElement('link')
          link.id   = cssId
          link.rel  = 'stylesheet'
          link.type = 'text/css'
          link.href = file
          link.media = 'all'
          link.addEventListener('load', () => {
            this.loadedStylesheets++
          })
          head.appendChild(link)
        }
        else {
          this.loadedStylesheets++
        }
      },
      setTheme(theme) {
        // Document Class
        var docThemeClass = 'theme-' + theme
        doc.classList.add(docThemeClass)

        function removeDocClass() {
          for (var i = 0; i < doc.classList.length; i++) {
            var className = doc.classList.item(i)
            if (className.indexOf('theme-') !== -1 && className !== docThemeClass) {
              doc.classList.remove(className)
            }
          }
        }

        // Load theme stylesheets
        // Assume the default theme is always loaded
        if (theme === 'default') {
          return removeDocClass()
        }

        $('.preloader').stop(true).show()

        this.loadedStylesheets = 0
        this.loadedStylesheetsDone = setInterval(() => {
          if (this.loadedStylesheets === themableStylesheets.length) {
            clearInterval(this.loadedStylesheetsDone)

            // reset drawer layout
            this.drawerLayoutNode.mdkDrawerLayout._resetLayout()

            // remove doc class
            removeDocClass()

            $('.preloader').fadeOut()
          }
        }, 100)

        themableStylesheets.forEach(link => {
          var path = link.href.replace('themes/default', 'themes/' + theme)
          this.loadStylesheet(path)
        })
      }
    }
  }
</script>